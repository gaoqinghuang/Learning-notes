# 复制
## 旧版复制功能的实现（版本<2.8）
### 两步，先同步，再命令传播
* 同步：初始化作用，将从服务器的数据库状态更新至主服务器当前所处的数据库状态。
* 命令传播：同步过后，如果主服务器的数据库状态被修改，导致主从数据库不一致时，让主从的数据库重新回到一致状态。

### 缺陷
如果从服务器网络断开后，再重新连接上，这时会触发同步操作，就算主从的数据才差了1s产生的数量几百上千个，也要把主数据库所有的数据重新同步，造成大量的资源（cpu，内存，磁盘I/O，带宽，流量）浪费

## 新版复制功能的实现
因为部分重同步浪费大量资源，新版就以此做优化。功能主要以下三部分构成
* 复制偏移量：主从服务器都会记录。记录最新数据的偏移量，比如开始是两边开始都是10086，然后主服务器像从服务器传播了长度为33字节的数据，那主服务器的复制偏移量就是10086+33=10119，如果从服务器接收到了数据，那也把复制偏移量更新为10119.在断开重连的时候主从会对比这个值来判定如何补偿丢失的数据
* 复制积压缓冲区：主服务器记录。固定长度，先进先出的队列，默认大小1MB.![构造](https://test-sc.seeyouyima.com/5e62239719384_540_130.png)
   
   记录这偏移量和具体命令传播时的内容
* 服务器运行ID：从服务器记录。记录着主服务器的ID，在部分重新同步的时候核对这次同步的主服务器是否还是上次那台，如果不是就要进行全量同步操作

具体的实现就是断开重连后，先根据服务器运行ID核对是否是上次的那台。接着对比复制偏移量从复制积压缓冲区拉取数据。如果核对补上或者发生错误都执行全量同步操作